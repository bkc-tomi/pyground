from django.shortcuts import render
from django.urls      import reverse
from django.http      import HttpResponse, HttpResponseRedirect

# モデル
from .models         import Code
from user.models     import User
from question.models import Question

"""
----------------------------------------------------------------------
プレイグランド／プレイグランド
----------------------------------------------------------------------
"""
def index(request):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    描画配列作成
    ---------------------------------------------------------
    """
    # コード ----------------------------------------
    # 初期値
    code_name = ""
    code = """
def fib(n):
    a, b = 0, 1
        while a < n:
            print(a, end=' ')
            a, b = b, a+b
        print()
    fib(1000)"""
    # 変更を更新

    # 実行結果 --------------------------------------
    result = """
    
    """
    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return render(request, 'playground/index.html', {
        'code_name'  : code_name,
        'code'       : code,
        'result'     : result,
    })

"""
----------------------------------------------------------------------
プレイグランド／実行処理　未実装
----------------------------------------------------------------------
"""
def run(request):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    値取得
    ---------------------------------------------------------
    """
    # コード ----------------------------------------

    """
    ---------------------------------------------------------
    コード実行
    ---------------------------------------------------------
    """
    """
    ---------------------------------------------------------
    実行結果作成
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    描画配列作成
    ---------------------------------------------------------
    """
    # コード ----------------------------------------
    # 初期値
    code_name = request.POST['code-name']
    code      = request.POST['code']
    # 変更を更新

    # 実行結果 --------------------------------------
    result = ""
    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return render(request, 'playground/index.html', {
        'code_name'  : code_name,
        'code'       : code,
        'result'     : result,
    })

"""
----------------------------------------------------------------------
プレイグランド／コード編集
----------------------------------------------------------------------
"""
def edit(request, code_id):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    描画データ取得
    ---------------------------------------------------------
    """
    try:
        code = Code.objects.get(pk=code_id)
    except Exception as e:
        print('err:' + str(e))
        return HttpResponseRedirect(reverse('top:top'))

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return render(request, 'playground/edit.html', {
        'code': code,
    })

"""
----------------------------------------------------------------------
プレイグランド／編集実行処理　未実装
----------------------------------------------------------------------
"""
def run_edit(request, code_id):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    値取得
    ---------------------------------------------------------
    """
    # コード ----------------------------------------

    """
    ---------------------------------------------------------
    コード実行
    ---------------------------------------------------------
    """
    """
    ---------------------------------------------------------
    実行結果作成
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    描画配列作成
    ---------------------------------------------------------
    """
    # コード ----------------------------------------

    # 実行結果 --------------------------------------

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return HttpResponseRedirect(
        reverse('playground:edit', args=(code_id,)),
    )

"""
----------------------------------------------------------------------
プレイグランド／問題ページ
----------------------------------------------------------------------
"""
def question(request, question_id):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    描画データ取得
    ---------------------------------------------------------
    """
    try:
        question = Question.objects.get(pk=question_id)
        
    except Exception as e:
        print('err:' + str(e))
        return HttpResponseRedirect(reverse('top:top'))

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return render(request, 'playground/question.html', {
        'question': question,
    })

"""
----------------------------------------------------------------------
プレイグランド／問題処理　未実装
----------------------------------------------------------------------
"""
def run_question(request, question_id):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    値取得
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    バリデーション
    ---------------------------------------------------------
    """
    """
    ---------------------------------------------------------
    前処理
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    データベース保存
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    後処理
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    描画データ取得
    ---------------------------------------------------------
    """

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return render(request, 'playground/question.html', {
        'question_id': question_id,
    })

"""
----------------------------------------------------------------------
プレイグランド／保存処理
----------------------------------------------------------------------
"""
def save(request):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    データベース保存
    ---------------------------------------------------------
    """
    # DB登録 ------------------------------------------
    try:
        code = Code(
            name           = request.POST['code-name'],
            code           = request.POST['code'],
            target_user_id = login_user['id'],
        )
        code.save()

    except Exception as e:
        print('err:' + str(e))
        return HttpResponseRedirect(request.META.get("HTTP_REFERER"))

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """

    return HttpResponseRedirect(
        reverse('playground:edit', args=(code.id,))
    )

"""
----------------------------------------------------------------------
プレイグランド／更新処理
----------------------------------------------------------------------
"""
def update(request, code_id):
    """
    ---------------------------------------------------------
    セッション
    ---------------------------------------------------------
    """
    if 'login_user' not in request.session:
        return HttpResponseRedirect(reverse('top:top'))
    
    login_user = request.session['login_user']

    """
    ---------------------------------------------------------
    データベース保存
    ---------------------------------------------------------
    """
    # DB更新 ------------------------------------------
    try:
        code = Code.objects.get(pk=code_id)
        code.name = request.POST['code-name']
        code.code = request.POST['code']
        code.save()

    except Exception as e:
        print('err:' + str(e))
        return HttpResponseRedirect(request.META.get("HTTP_REFERER"))

    """
    ---------------------------------------------------------
    ページ遷移
    ---------------------------------------------------------
    """
    return HttpResponseRedirect(
        reverse('playground:edit', args=(code.id,))
    )